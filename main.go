package main

import (
	"bufio"
	"fmt"
	"os"
	"os/signal"
	"runtime"
	"strconv"
	"strings"
	"sync"
	"sync/atomic"
	"syscall"
	"time"
)

const (
	// Format used to print the current status of the program
	STATUS_FORMAT = "\r\033[KRate: %d | Success: %d | At: %s"

	// 15Mb
	MAX_RESPONSE_LENGTH = 15 * 1024 * 1024
)

var (
	// Amount of times the scanner connect (if OnlyConnect is true) or saved to the database successfully
	SUCCESS = int64(0)
	// For use when going to log an error but the program is shutting down
	SHUTTING_DOWN = false
)

func main() {
	hagelslag, err := NewHagelslag()
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	writer := bufio.NewWriter(os.Stderr)
	defer writer.Flush()

	status := time.NewTicker(1 * time.Second).C

	signals := make(chan os.Signal, 1)
	signal.Notify(signals, syscall.SIGINT, syscall.SIGTERM)

	semaphore := make(chan struct{}, hagelslag.Rate)
	addresses := make(chan string)

	var wg sync.WaitGroup
	for range runtime.NumCPU() {
		wg.Add(1)
		go hagelslag.worker(addresses, semaphore, &wg)
	}

	ip, port, err := getStartingIPAndPort(hagelslag.StartingIP, hagelslag.Port)
	if err != nil {
		fmt.Println(err)
		writer.Flush()
		os.Exit(1)
	}

	// Main loop
	for {
		select {
		// Print status every second
		case <-status:
			success := atomic.LoadInt64(&SUCCESS)
			fmt.Fprintf(writer, STATUS_FORMAT, hagelslag.Rate, success, parseAddress(ip, port))
			writer.Flush()

		// Handle SIGINT and SIGTERM signals
		case <-signals:
			fmt.Printf("\nShutting down...\n")

			SHUTTING_DOWN = true
			close(addresses)
			wg.Wait()

			address := parseAddress(ip, port)
			if strings.HasPrefix(address, "255.0.0.0") {
				fmt.Println("Done.")
			} else {
				fmt.Printf("Last IP: %s\n", address)
			}

			return

		// Increment the IP
		default:
			if ip >= 0xFF000000 {
				signals <- syscall.SIGTERM
				continue
			}

			if isReserved(&ip) {
				os.Stderr.WriteString("\nReserved range reached, skipping to next available range.\n")
			}

			address := parseAddress(ip, port)

			// Get a slot to work on a task
			semaphore <- struct{}{}

			// Send the address to workers
			addresses <- address

			ip++
		}
	}
}

func getStartingIPAndPort(ip string, port string) (uint32, uint16, error) {
	ipUint, err := parseIP(ip)
	if err != nil {
		return 0, 0, fmt.Errorf("failed parsing starting IP: %s", err)
	}

	portInt, err := strconv.Atoi(port)
	if err != nil {
		return 0, 0, fmt.Errorf("failed parsing port: %s", err)
	}

	portUint := uint16(portInt)

	return ipUint, portUint, nil
}

// ************#*#******####*########***#####################%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@@@%%%@@@@@@@@@@@@@@@@@@@
// ************************************##################%##%%%@@@@@@@@@@@@@@@@@@@@@@@@@%%#@@@%#**+++++**#%@@@@%%@@@@%%%@@@@%@@@@@@@@@@@@@@
// **++++++**************************#####%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+:.:.:..              :-+##%%%@#*#%@@@%@@@@@@@@@@@@@@
// ++==++++******######%%%%%%%%%%%%%%%%%%%###########%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@%-    ...          .        .=*-... .+@@%@@@@@@@@@@@@@@
// ####%%%%%####*****++++++++++***########%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@#:   .:...          ....        .      .*%@@@@@@@@@@@@@@
// +++++++*****###########%##################%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@=    -..      :        .:.                *@@@@@@@@@@@@@@
// ..::......::..::--=+***********###################%%%%%%@@@@@@@@@@@@@@@@@@@@@%:   .=.       .::        .::               .#%%%%%%@@@@@@@
//             ...:::.:=++++**######*#***######%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@%.    :      .... :          =                =###%%%%%%%%%%
// :::-::::--------==*#%%%#*******########%%####%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@%.    :      ..:.   :..        :                +***#%%%@@@@@
// +--::::::::::::--=#%@#***###***####*######%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-    ..    .::.      :.:       :          .     =%@@@@@@@@@@@
// @%+:::::::::::::-**#@##*#####%%%%%@@@@@%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@%     :   :--:         :.:.      :         ..    .#%@@@@@@@@@@
// %@@@#=-::--::.:-=**#@###%%#########**######%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@=    ...:+=:.:.        ::::::    :          .     *%@@@@@@@@@@
// %%@@@@@%+---:.-#=***%########*#*##*######%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@:    -::.               ..:::..  :        : .     +@@@@@@@@@@@
// ##*#%@@@@%+-::*%+***%##**######%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@     :    ...::        .:... ..::-        .:.   . -%@@@@@@@@@@
// +*****#%@%++***%+**#@##*%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@%----+     .  .:--.          .         :       .:-.   . :%@@@@@@@@@@
// *********#@++*#%+**#@##****#######%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%=..+ .   :.-+%##*-.        :=*##*=+:.:       ...  ... .=*#%@@@@@@@
// **********##++===**#@##+***####%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%=..-   +.                  -:::.:-:-       :    : :..::.=@@@@@@@
// **********#%#%%**=##@***#####%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#=-. .+-        ..                :    . .    .    .=#@@@@@@@@@
// **********#%#%#*++##@**#%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@-==..*-.       ::               :::  .=:....   .   *@@@@@@@@@@
// *********#%+%@@++:##@###%%%%@@@@%%##*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@ .::.+.                        .-:..:-++.....      #@@@@@@@@@@
// ********#%+#@@*++-+#@#**#####%%%%@@@@+@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%* :..#==       .                  -..=-=:-          #@@@@@@@@@@
// *****##%**%%*+++++++=#%@@@@@@@@@@@@@@#*@%%%%%%%%%%@@@@@@@@@@@@@@%%%%%%%%%- : -*.-:.      ..........         .#+.#:.          =@@@@@@%%%#
// ****######%*#*+++++*+#@@@@@@@@@@@@@@@@+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%* .: -*.-.-:                      .+@@=-*-           :%########*
// %@@@@@@@@%%#@@@*-#@@**@@@@@@@@@@@@@@@@@+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#. :. .: - :.--.                 .=%%@@:+*:           .**********
// @@@@@@%%@@@@@@%#-#*+:  -%@@@@@@@@@@@@@@*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#=  :     ...:.+#+-.            .  +%%%#.-=            .=+*****#**
// @@@@@*  +%%%%%%%***::-. :%@@@@@@@@@@@@@@+%############################*   ..     : :.-#***+-.......      =***=..             -:*********
// @@@@@@+:+*##%%%%%%#####*.-@@@@@@@@@@@@@@%+%#################%%########-    :     :  :.*##**=             :++*:.              = ++++**##%
// @@@@+:-**=---+##*%%#####:.@@@@@@@@@@@@@@@**%%%%%%#####################.    :.     :  -=###*+              :+=.               + =+*###%%%
// @@@@+: =###****+-#+-=-+#- @@@@@@@@@@@@@@@@+%##########################:.    :     ..  +=--:-               :                .+ =*###%##%
// @@@@%**#####***#*%***###= ::==+*##%%%%%%@@#+#######**********##**+==:. .::  .:     :  .:   :              .                 -= -*****###
// @@@@-  +*#*****#*#****##+                        .:=+**#+=-:.            .:  :.     :  :   .             :                 :-  -==++++**
// @@@@%+=*##****#####***##*                                                  :  :     :  :                ..                .  .---=======
// @@@@#:-###**######*#**###                                                   :  :    :  -....    . ......:                .:------=======
// @@@@@@#*#######%%%#*##%#%-:..                                               .: ..   .. :       .       :       .          ---------=-=--
// @@@@@@*##%%###%########**@@@@@%#*+=:.                                  .:::. :  :    : :              ..      :           :-----=-------
// @@@@@%*###*##########**--%@@@@@@@@@@@@%#*+=-:.                 .:--=+++++=+-:.: ..   : :              :   .  ..           :--------=----
// @@@@@%#################+#@@@@@@@@@@@@@@@@@@@@@@***++=========++++++++++++++++.+  :   : :             ...     :  .         :--------:----
// @@@@@@@@%%%@@@@@@@@@@%%@@@@@@@@@@@@@@@@@@@@@@@@@+**********+++++++++++++++=   -  :   : :             : : :  :. .          ...:::....::::
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%****++++++********++++++++...:. -   :.=             :.- :  : ..                      ..
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@***************++*******++    : +  .::  ............:--..  : :
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+#***********+++++++++++-    :.-  - :....   .......-:::  ....
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#****##******++****++===-    -:: .*.-              :--:  : :
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*+==***++=+***###*+++++++++:   -::.--.=              ::-:  . :
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#*++====+*##+:    .=+*+****+**++++=   =  ::.-:              ::::  : :
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%*++=-=+++#%%@@@@@%.         :-=********=      :- : .             .=::. -.-
// @@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#*+====++*#%%@@@@@@@@@@=             .---+**+-       :   .              =.:: :::
// @@@@@@@@@@@@@@@@@@@@@@@%#*+====++*#%%@@@@@@@@@@@@@@@#.                     .            :               :- :.=                         :
// @@@@@@@@@@@@@@@@@%#**+===++*#%%@@@@@@@@@@@@@@@@@@@@@:.                    .              :               =:. +.                     :==-
// @@@@@@@@@@@@%**+====+*#%%@@@@@@@@@@@@@@@@@@@@@@@@@@#=*=::                 .               .              ::  -                  ..:----=
// @@@@@@%**+=-==+*#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%##%%**+*#-               :               .              : . -               -=+=--=====
// %#*+=-=+++*%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@#+=%%#%%%%%%#:              ...              .               . :           . -+===========
